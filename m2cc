#!/bin/bash
set -ue
FILE=${1-}
: ${M2DIR=~/M2-Planet/M2-Planet}
: ${ARCH=x86}

LIBDIR="${M2DIR}/M2libc"

PERL="perl"
PERL="perlbrew exec --with perl-5.8.0 perl"
#PERL="perlbrew exec --with perl-5.39.10 perl"
cpp -D_STDC_PREDEF_H -D__M2__ -D__i386__ -nostdinc -I "$LIBDIR" "$FILE" -H -o /dev/null 2> out.dep

KAEM="kaem.run"

cat > "$KAEM" <<EOF
true 'autogenerated by m2cc'
set -e

FILE="${FILE}"
ARCH="${ARCH}"
M2DIR="${M2DIR}"
LIBDIR="\${M2DIR}/M2libc"

rm -f out.M1 out.hex2 out

\${M2DIR}/bin/M2-Planet \\
	--architecture \${ARCH} \\
EOF

$PERL dep.pl out.dep "${FILE}" | tsort | sed -n '\!'"$LIBDIR"'/!{s//\t-f ${LIBDIR}\//;s/$/ \\/p}' >> "$KAEM"

cat >> "$KAEM" <<EOF
	-f \${FILE} \\
	-o out.M1

M1 -f \${LIBDIR}/\${ARCH}/\${ARCH}_defs.M1 -f \${LIBDIR}/\${ARCH}/libc-core.M1 -f out.M1 --little-endian --architecture \${ARCH} -o out.hex2
hex2 -f \${LIBDIR}/\${ARCH}/ELF-\${ARCH}.hex2 -f out.hex2 --little-endian --architecture \${ARCH} --base-address 0x8048000 -o out

echo "successfully compiled \"out\""
ls -l out
EOF

kaem -f "$KAEM"
